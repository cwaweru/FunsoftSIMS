/*
 * QueryDialog.java
 *
 * Created on March 29, 2004, 9:36 AM
 */

package com.afrisoftech.dbadmin;

/**
 *
 * @author  root
 */
public class GraphicalQueryDialog extends javax.swing.JDialog {
    
    java.lang.String sqlStringFile = null;
    
    java.lang.String queryString = null;
    
    java.lang.String loadQueryFile = null;
    
    java.io.File filePortrait = null;
    

    
    com.afrisoftech.dbadmin.GraphicalView parentTableView = null;
    
    com.afrisoftech.hospital.HospitalMain hospitalMain = null;
    
//    java.lang.String queryFileName = null;
    
    /** Creates new form QueryDialog */
    public GraphicalQueryDialog(java.awt.Frame parent, boolean modal, com.afrisoftech.dbadmin.GraphicalView graphicalView, com.afrisoftech.hospital.HospitalMain hospitalmain) {
        super(parent, modal);
        parentTableView = graphicalView;
        hospitalMain = hospitalmain;
        
        initComponents();
    }
    
    
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    private void initComponents() {//GEN-BEGIN:initComponents
        java.awt.GridBagConstraints gridBagConstraints;

        querykiwiTextPanel = new com.afrisoftech.lib.KiwiTextPanel();
        queryPane = new javax.swing.JPanel();
        saveQuery = new javax.swing.JButton();
        clearQuery = new javax.swing.JButton();
        loadQuery = new javax.swing.JButton();
        subminQueryPane = new javax.swing.JPanel();
        closeDialog = new javax.swing.JButton();
        submitQuery = new javax.swing.JButton();
        mainLabel = new javax.swing.JPanel();
        QueryTipLabel = new javax.swing.JLabel();
        helPanel = new javax.swing.JPanel();
        helpButton = new javax.swing.JButton();
        spacerPanel = new javax.swing.JPanel();
        QueryIcon = new javax.swing.JLabel();

        getContentPane().setLayout(new java.awt.GridBagLayout());

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Custom Query Dialog");
        addWindowListener(new java.awt.event.WindowAdapter() {
            public void windowClosing(java.awt.event.WindowEvent evt) {
                closeDialog(evt);
            }
        });

        querykiwiTextPanel.setBorder(new javax.swing.border.TitledBorder("Query Text Field"));
        querykiwiTextPanel.setToolTipText("Please type in your query and press \"submit query\"");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.gridwidth = 4;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 50.0;
        gridBagConstraints.weighty = 50.0;
        getContentPane().add(querykiwiTextPanel, gridBagConstraints);

        queryPane.setLayout(new java.awt.GridBagLayout());

        queryPane.setBorder(new javax.swing.border.TitledBorder("Load/Save Query"));
        saveQuery.setMnemonic('S');
        saveQuery.setText("Save Query");
        saveQuery.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                saveQueryActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(2, 2, 2, 2);
        queryPane.add(saveQuery, gridBagConstraints);

        clearQuery.setMnemonic('l');
        clearQuery.setText("Clear Query");
        clearQuery.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                clearQueryActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(2, 2, 2, 2);
        queryPane.add(clearQuery, gridBagConstraints);

        loadQuery.setMnemonic('L');
        loadQuery.setText("Load Query");
        loadQuery.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                loadQueryActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(2, 2, 2, 2);
        queryPane.add(loadQuery, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 4;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        getContentPane().add(queryPane, gridBagConstraints);

        subminQueryPane.setLayout(new java.awt.GridBagLayout());

        subminQueryPane.setBorder(new javax.swing.border.TitledBorder("Submit/Close query dialog"));
        closeDialog.setMnemonic('C');
        closeDialog.setText("Close Query Dialog");
        closeDialog.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                closeDialogActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 3;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        subminQueryPane.add(closeDialog, gridBagConstraints);

        submitQuery.setMnemonic('Q');
        submitQuery.setText("Submit Query");
        submitQuery.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                submitQueryActionPerformed(evt);
            }
        });

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        subminQueryPane.add(submitQuery, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        getContentPane().add(subminQueryPane, gridBagConstraints);

        mainLabel.setLayout(new java.awt.GridBagLayout());

        mainLabel.setBorder(new javax.swing.border.TitledBorder(""));
        QueryTipLabel.setForeground(new java.awt.Color(0, 0, 102));
        QueryTipLabel.setText("Type your custom query in the text field provided below.");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridwidth = 4;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        mainLabel.add(QueryTipLabel, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        getContentPane().add(mainLabel, gridBagConstraints);

        helPanel.setLayout(new java.awt.GridBagLayout());

        helPanel.setBorder(new javax.swing.border.TitledBorder("Assistance"));
        helpButton.setMnemonic('H');
        helpButton.setText("Help");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        gridBagConstraints.insets = new java.awt.Insets(2, 2, 2, 2);
        helPanel.add(helpButton, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 4;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        getContentPane().add(helPanel, gridBagConstraints);

        spacerPanel.setLayout(new java.awt.GridBagLayout());

        spacerPanel.setBorder(new javax.swing.border.TitledBorder(""));
        QueryIcon.setIcon(new javax.swing.ImageIcon(getClass().getResource("/beyondIcon.gif")));
        QueryIcon.setBorder(new javax.swing.border.BevelBorder(javax.swing.border.BevelBorder.RAISED));
        spacerPanel.add(QueryIcon, new java.awt.GridBagConstraints());

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 4;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 1.0;
        gridBagConstraints.weighty = 1.0;
        getContentPane().add(spacerPanel, gridBagConstraints);

        pack();
        java.awt.Dimension screenSize = java.awt.Toolkit.getDefaultToolkit().getScreenSize();
        setSize(new java.awt.Dimension(628, 275));
        setLocation((screenSize.width-628)/2,(screenSize.height-275)/2);
    }//GEN-END:initComponents
    
    private void loadQueryActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_loadQueryActionPerformed
        
        javax.swing.JFileChooser chooserPortrait = new javax.swing.JFileChooser(new java.io.File(System.getProperty("user.dir")));
        
        com.afrisoftech.lib.ExampleFileFilter filter = new com.afrisoftech.lib.ExampleFileFilter();
        
        filter.addExtension("sqy");
        
        filter.setDescription("SQL Query Files");
        
        chooserPortrait.setFileFilter(filter);
        
        int returnVal = chooserPortrait.showOpenDialog(this);
        
        if(returnVal == javax.swing.JFileChooser.APPROVE_OPTION) {
            
            System.out.println("You chose to open this file: " +
            
            chooserPortrait.getSelectedFile().getName());
            
            filePortrait = chooserPortrait.getSelectedFile();
            
            loadQueryFile = filePortrait.getName();
            
        }
        
        //        this.invalidate();
        
        try {
            
            try {
                
                java.io.FileInputStream requisFileIOStream = new java.io.FileInputStream(filePortrait);
                
                java.io.ObjectInputStream requisObjInStream = new java.io.ObjectInputStream(requisFileIOStream);
                
                java.lang.String  queryString = (java.lang.String)requisObjInStream.readObject();
                
                //  jScrollPane1.setViewportView(requisTable);
                
                querykiwiTextPanel.setText(queryString);
                
                this.validate();
                
            } catch(java.lang.ClassNotFoundException cnfExec) {
                
                javax.swing.JOptionPane.showMessageDialog(this, cnfExec.getMessage());
                
            }
            
        } catch(java.io.IOException ioExec) {
            
            javax.swing.JOptionPane.showMessageDialog(this, ioExec.getMessage());
            
        }                // Add your handling code here:
    }//GEN-LAST:event_loadQueryActionPerformed
    
    private void saveQueryActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_saveQueryActionPerformed
        
        javax.swing.JFileChooser chooserPortrait = new javax.swing.JFileChooser(new java.io.File(System.getProperty("user.dir")));
        
        com.afrisoftech.lib.ExampleFileFilter filter = new com.afrisoftech.lib.ExampleFileFilter();
        
        filter.addExtension("sqy");
        
        filter.setDescription("SQL Query Files");
        
        chooserPortrait.setFileFilter(filter);
        
        int returnVal = chooserPortrait.showSaveDialog(this);
        
        if(returnVal == javax.swing.JFileChooser.APPROVE_OPTION) {
            
            System.out.println("You chose to Save as this file: " +
            
            chooserPortrait.getSelectedFile().getName());
            
            filePortrait = chooserPortrait.getSelectedFile();
            
            sqlStringFile = filePortrait.getName();
            
        }
        
        java.io.File requisFile;
        
        java.io.FileOutputStream requistOutStream;
        
        java.io.ObjectOutputStream requisObjStream;
        
        try {
            
            if (querykiwiTextPanel.getText().toCharArray().length > 0) {
                
                requisFile = java.io.File.createTempFile(sqlStringFile+"_", ".sqy", new java.io.File(System.getProperty("user.dir")));
                
                //          requisFile.deleteOnExit();
                
                requistOutStream = new java.io.FileOutputStream(requisFile);
                
                requisObjStream = new java.io.ObjectOutputStream(requistOutStream);
                
                requisObjStream.writeObject(querykiwiTextPanel.getText());
                
                requisObjStream.flush();
                
            } else {
                
                javax.swing.JOptionPane.showMessageDialog(new java.awt.Frame(), "Can't serialize an empty query!", "Warning on empty query", javax.swing.JOptionPane.ERROR_MESSAGE);
                
            }
            //            requisObjStream.writeObject(jTable11);
            
            
            
        } catch(java.io.IOException IOexec) {
            
            javax.swing.JOptionPane.showMessageDialog(this, IOexec.getMessage());
            
        }
        
        // Add your handling code here:
    }//GEN-LAST:event_saveQueryActionPerformed
    
    private void submitQueryActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_submitQueryActionPerformed
        
        java.util.Vector sortVector = new java.util.Vector(1,1);
        
        boolean pastFrom = false;
        
        if (querykiwiTextPanel.getText().toCharArray().length > 0) {
            
            queryString = querykiwiTextPanel.getText();
            
            hospitalMain.queryString = queryString.toLowerCase();
            
            hospitalMain.tableColumnsVector = hospitalMain.getTableColumnsFromQuery(queryString.toLowerCase());
            
            hospitalMain.xaxisComboBox.setModel(new javax.swing.DefaultComboBoxModel(hospitalMain.tableColumnsVector));
            
            java.util.StringTokenizer sqlTokenizer = new java.util.StringTokenizer(queryString.toLowerCase());
            
            System.out.println("Query String ["+queryString+"]");
            
            while (sqlTokenizer.hasMoreTokens()) {
                
                sortVector.addElement(sqlTokenizer.nextToken());
  
            }
            
            for (int i = 0; i < sortVector.size(); i++) {
                
                if (sortVector.get(i).toString().equalsIgnoreCase("from")) {
                 
                    hospitalMain.setSelectedTable(sortVector.get(i+1).toString());
                    
                }
                
            }
            
            hospitalMain.graphViewDialog.setVisible(true);
            
//            parentTableView.setQueryString(queryString.toLowerCase());
            
//            parentTableView.populateCustomQueryTable();
            
            this.dispose();
            
        } else {
            
            javax.swing.JOptionPane.showMessageDialog(new java.awt.Frame(), "Can't process data for an empty query!", "Warning on empty query", javax.swing.JOptionPane.ERROR_MESSAGE);
            
        }
        
        // Add your handling code here:
    }//GEN-LAST:event_submitQueryActionPerformed
    
    private void clearQueryActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_clearQueryActionPerformed
        
        querykiwiTextPanel.setText("");
        // Add your handling code here:
    }//GEN-LAST:event_clearQueryActionPerformed
    
    private void closeDialogActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_closeDialogActionPerformed
        
        this.dispose();
        
        // Add your handling code here:
    }//GEN-LAST:event_closeDialogActionPerformed
    
    /** Closes the dialog */
    private void closeDialog(java.awt.event.WindowEvent evt) {//GEN-FIRST:event_closeDialog
        setVisible(false);
        dispose();
    }//GEN-LAST:event_closeDialog
    
    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        //        new QueryDialog(new javax.swing.JFrame(), true).show();
    }
    
    
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel subminQueryPane;
    private javax.swing.JButton closeDialog;
    private javax.swing.JLabel QueryTipLabel;
    private javax.swing.JPanel helPanel;
    private javax.swing.JButton clearQuery;
    private javax.swing.JPanel spacerPanel;
    private javax.swing.JPanel mainLabel;
    private javax.swing.JPanel queryPane;
    private com.afrisoftech.lib.KiwiTextPanel querykiwiTextPanel;
    private javax.swing.JLabel QueryIcon;
    private javax.swing.JButton submitQuery;
    private javax.swing.JButton loadQuery;
    private javax.swing.JButton saveQuery;
    private javax.swing.JButton helpButton;
    // End of variables declaration//GEN-END:variables
    
}
